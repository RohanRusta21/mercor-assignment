name: Build and Push Docker Image to DockerHub

on:
  push:
    branches:
      - main

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USER }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      - name: Build Frontend Docker Image
        run: |
          cd mercor-frontend
          docker build -t "${DOCKERHUB_USERNAME}/${{ github.event.repository.name }}-frontend:${{ github.run_number}}" -f Dockerfile.frontend .
      - name: Build Backend Docker Image
        run: |
          cd mercor-backend
          docker build -t "${DOCKERHUB_USERNAME}/${{ github.event.repository.name }}-backend:${{ github.run_number}}" -f Dockerfile.backend .
      - name: Login to DockerHub
        run: echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
      - name: Push Frontend Docker Image to DockerHub
        run: docker push "${DOCKERHUB_USERNAME}/${{ github.event.repository.name }}-frontend:${{ github.run_number}}"
      - name: Push Backend Docker Image to DockerHub
        run: docker push "${DOCKERHUB_USERNAME}/${{ github.event.repository.name }}-backend:${{ github.run_number}}"

  send-email:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      
      - name: Send Email Notification
        env:
          SMTP_HOST: sandbox.smtp.mailtrap.io
          SMTP_PORT: 587
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          TO_EMAIL: shivangrustagi04@gmail.com
          FROM_EMAIL: rohanrustagi21@gmail.com
        run: |
          curl \
            --ssl-reqd \
            --url 'smtp://sandbox.smtp.mailtrap.io:2525' \
            --user '${{ secrets.SMTP_USERNAME }}:${{ secrets.SMTP_PASSWORD }}' \
            --mail-from ${{ env.FROM_EMAIL }} \
            --mail-rcpt ${{ env.TO_EMAIL }} \
            --upload-file - <<EOF
            From: Magic Elves <${{ env.FROM_EMAIL }}>
            To: Mailtrap Inbox <${{ env.TO_EMAIL }}>
            Subject: You are awesome!
            Content-Type: multipart/alternative; boundary="boundary-string"

            --boundary-string
            Content-Type: text/plain; charset="utf-8"
            Content-Transfer-Encoding: quoted-printable
            Content-Disposition: inline

            Congrats for sending a test email with Mailtrap!

            If you are viewing this email in your inbox, the integration works.
            Now send your email using our SMTP server and integration of your choice!

            Good luck! Hope it works.

            --boundary-string
            Content-Type: text/html; charset="utf-8"
            Content-Transfer-Encoding: quoted-printable
            Content-Disposition: inline

            <!doctype html>
            <html>
              <head>
                <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
              </head>
              <body style="font-family: sans-serif;">
                <div style="display: block; margin: auto; max-width: 600px;" class="main">
                  <h1 style="font-size: 18px; font-weight: bold; margin-top
